name: Create or Update Jira Issue
on:
  issues:
    types:
      - opened
jobs:
  manage-issue:
    name: Manage Jira Issue
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Parse and Validate GitHub Issue Body
        id: validate-body
        run: |
          parentKey=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=parentKey: )\S+')
          childKey=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=childKey: )\S+')
          branch=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=branch: )\S+')
          description=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=description: ).*')
          if [[ -z "$parentKey" ]]; then
            echo "Error: parentKey is required but not provided."
            exit 1
          fi
          echo "parentKey=$parentKey" >> $GITHUB_ENV
          echo "childKey=$childKey" >> $GITHUB_ENV
          echo "branch=$branch" >> $GITHUB_ENV
          echo "description=$description" >> $GITHUB_ENV

      - name: Check if Child Task Exists
        id: check-task
        run: |
          if [[ -n "${{ env.childKey }}" ]]; then
            response=$(curl -s -o response.json -w "%{http_code}" \
              -H "Authorization: Basic ${{ secrets.JIRA_AUTH }}" \
              -H "Content-Type: application/json" \
              "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ env.childKey }}")
            if [[ "$response" == "200" ]]; then
              echo "issue_exists=true" >> $GITHUB_ENV
            else
              echo "issue_exists=false" >> $GITHUB_ENV
            fi
          else
            echo "issue_exists=false" >> $GITHUB_ENV
          fi

      - name: Update Child Task to In Progress
        if: ${{ env.issue_exists == 'true' }}
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ env.childKey }}
          transition: "In Progress"

      - name: Convert Markdown to Jira Syntax
        if: ${{ env.issue_exists == 'false' }}
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            ### Github Issue Link
            - ${{ github.event.issue.html_url }}

            ${{ env.description }}
          mode: md2jira

      - name: Create New Child Task
        if: ${{ env.issue_exists == 'false' }}
        id: create-task
        uses: atlassian/gajira-create@v3
        with:
          project: HW
          issuetype: Task
          summary: '${{ github.event.issue.title }}'
          description: '${{ steps.md2jira.outputs.output-text }}'
          fields: |
            {
              "parent": {
                "key": "${{ env.parentKey }}"
              }
            }

      - name: Create Branch for Task
        if: ${{ env.issue_exists == 'false' }}
        run: |
          git fetch origin
          git checkout -b ${{ env.branch }}
          git push origin ${{ env.branch }}

      - name: Add Comment with Jira Task Link
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ${{ env.issue_exists == 'true' && 'Updated existing child task to In Progress: [${{ env.childKey }}](${ secrets.JIRA_BASE_URL }}/browse/${{ env.childKey }})' || 'New child task created under parent task: [${{ steps.create-task.outputs.issue }}](${ secrets.JIRA_BASE_URL }}/browse/${{ steps.create-task.outputs.issue }})' }}
